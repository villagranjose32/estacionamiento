{% extends "base.html" %}

{% block title %}Nuevo Abono Mensual - Sistema de Estacionamiento{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus"></i> Registrar Nuevo Abono Mensual</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="abonoForm">
                    {{ csrf_token() if csrf_token }}
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="placa" class="form-label">
                                    <i class="fas fa-id-card"></i> Placa del Vehículo *
                                </label>
                                <input type="text" class="form-control" id="placa" name="placa" 
                                       placeholder="Ej: ABC123, XYZ789, DEF12A" required maxlength="8" 
                                       minlength="3"
                                       title="Ingrese la placa del vehículo (mínimo 3 caracteres)"
                                       style="text-transform: uppercase;">
                                <div class="valid-feedback">
                                    ✓ Placa ingresada correctamente
                                </div>
                                <div class="invalid-feedback">
                                    La placa debe tener entre 3 y 8 caracteres
                                </div>
                                <div class="form-text">Formatos aceptados: ABC123, XYZ789, DEF12A, ABC-123, etc.</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="tipo_vehiculo" class="form-label">
                                    <i class="fas fa-car"></i> Tipo de Vehículo *
                                </label>
                                <select class="form-select" id="tipo_vehiculo" name="tipo_vehiculo" required>
                                    <option value="">Seleccione el tipo</option>
                                    {% for tipo, tarifa in tarifas.items() %}
                                    <option value="{{ tipo }}" data-costo="{{ costos_abonos[tipo] }}">
                                        {{ tipo.capitalize() }} - {{ tarifa|currency }}/hora
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="propietario" class="form-label">
                                    <i class="fas fa-user"></i> Nombre del Propietario *
                                </label>
                                <input type="text" class="form-control" id="propietario" name="propietario" 
                                       placeholder="Nombre completo del propietario" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefono" class="form-label">
                                    <i class="fas fa-phone"></i> Teléfono (Opcional)
                                </label>
                                <input type="tel" class="form-control" id="telefono" name="telefono" 
                                       placeholder="Ej: 300-123-4567">
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope"></i> Email (Opcional)
                                </label>
                                <input type="email" class="form-control" id="email" name="email" 
                                       placeholder="Ej: propietario@email.com">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información del Abono -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> Detalles del Abono Mensual:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><strong>Vigencia:</strong> 30 días desde hoy</li>
                                    <li><strong>Descuento:</strong> 10% en cada uso</li>
                                    <li><strong>Renovación:</strong> Disponible antes del vencimiento</li>
                                    <li><strong>Costo:</strong> Depende del tipo de vehículo</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    <h5 id="costo-display" class="text-success mb-0">Seleccione tipo de vehículo</h5>
                                    <small class="text-muted">Precio del abono mensual</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de precios por tipo -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-list"></i> Precios por Tipo de Vehículo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for tipo, costo in costos_abonos.items() %}
                                <div class="col-md-4 text-center mb-2">
                                    <div class="p-3 border rounded">
                                        <i class="fas fa-{{ 'motorcycle' if tipo == 'moto' else ('car' if tipo == 'auto' else 'truck') }} fa-2x text-primary"></i>
                                        <h6 class="mt-2">{{ tipo.capitalize() }}</h6>
                                        <p class="mb-0"><strong>{{ costo|currency }}</strong></p>
                                        <small class="text-muted">{{ tarifas[tipo]|currency }}/hora</small>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cálculo de Ahorro -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6><i class="fas fa-calculator"></i> Calculadora de Ahorro</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Horas promedio por día:</label>
                                    <input type="number" id="calc-horas" class="form-control" value="8" min="1" max="24">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Días por mes:</label>
                                    <input type="number" id="calc-dias" class="form-control" value="22" min="1" max="30">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Ahorro estimado:</label>
                                    <div class="form-control" style="background-color: #e9ecef;">
                                        <span id="calc-ahorro" class="text-success fw-bold">-</span>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                * Cálculo basado en tarifa de auto ($2,500/hora) con descuento del 10%
                            </small>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <a href="{{ url_for('gestionar_abonos') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Registrar Abono
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Convertir placa a mayúsculas y validar formato flexible
document.getElementById('placa').addEventListener('input', function() {
    // Convertir a mayúsculas y limpiar caracteres especiales excepto guiones
    let valor = this.value.toUpperCase();
    // Permitir letras, números y guiones
    valor = valor.replace(/[^A-Z0-9\-]/g, '');
    this.value = valor;
    
    // Validación más flexible
    const longitudValida = valor.length >= 3 && valor.length <= 8;
    const contieneLetrasYNumeros = /[A-Z]/.test(valor) && /[0-9]/.test(valor);
    
    if (valor.length === 0) {
        this.classList.remove('is-invalid', 'is-valid');
    } else if (longitudValida && (contieneLetrasYNumeros || valor.length >= 3)) {
        this.classList.add('is-valid');
        this.classList.remove('is-invalid');
    } else if (valor.length >= 3) {
        // Si tiene al menos 3 caracteres, mostrar como válido temporalmente
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
    } else {
        this.classList.add('is-invalid');
        this.classList.remove('is-valid');
    }
});

// Objeto con costos y tarifas por tipo
const costosPorTipo = {
    {% for tipo, costo in costos_abonos.items() %}
    '{{ tipo }}': {
        costo: {{ costo }},
        tarifa: {{ tarifas[tipo] }}
    }{{ ',' if not loop.last }}
    {% endfor %}
};

// Actualizar precio cuando cambie el tipo de vehículo
document.getElementById('tipo_vehiculo').addEventListener('change', function() {
    const tipo = this.value;
    const costoDisplay = document.getElementById('costo-display');
    
    if (tipo && costosPorTipo[tipo]) {
        const costo = costosPorTipo[tipo].costo;
        costoDisplay.textContent = '$' + costo.toLocaleString('es-CO');
        costoDisplay.className = 'text-success mb-0';
    } else {
        costoDisplay.textContent = 'Seleccione tipo de vehículo';
        costoDisplay.className = 'text-muted mb-0';
    }
    
    calcularAhorro();
});

// Calculadora de ahorro
function calcularAhorro() {
    const horas = parseInt(document.getElementById('calc-horas').value) || 0;
    const dias = parseInt(document.getElementById('calc-dias').value) || 0;
    const tipo = document.getElementById('tipo_vehiculo').value;
    
    if (!tipo || !costosPorTipo[tipo]) {
        document.getElementById('calc-ahorro').textContent = 'Seleccione tipo de vehículo';
        document.getElementById('calc-ahorro').className = 'text-muted fw-bold';
        return;
    }
    
    const tarifaPorHora = costosPorTipo[tipo].tarifa;
    const costoAbono = costosPorTipo[tipo].costo;
    
    const horasTotales = horas * dias;
    const costoSinAbono = horasTotales * tarifaPorHora;
    const costoConAbono = costoAbono + (costoSinAbono * 0.9); // Con 10% descuento
    const ahorro = costoSinAbono - costoConAbono;
    
    const ahorroElement = document.getElementById('calc-ahorro');
    if (ahorro > 0) {
        ahorroElement.textContent = '$' + Math.round(ahorro).toLocaleString('es-CO');
        ahorroElement.className = 'text-success fw-bold';
    } else {
        ahorroElement.textContent = 'No hay ahorro';
        ahorroElement.className = 'text-warning fw-bold';
    }
}

// Eventos para la calculadora
document.getElementById('calc-horas').addEventListener('input', calcularAhorro);
document.getElementById('calc-dias').addEventListener('input', calcularAhorro);

// Calcular inicialmente
calcularAhorro();

// Validación del formulario antes del envío
document.getElementById('abonoForm').addEventListener('submit', function(e) {
    const placa = document.getElementById('placa').value;
    const tipo = document.getElementById('tipo_vehiculo').value;
    const propietario = document.getElementById('propietario').value.trim();
    
    // Validar placa con criterios más flexibles
    if (placa.length < 3) {
        e.preventDefault();
        alert('La placa debe tener al menos 3 caracteres');
        document.getElementById('placa').focus();
        return false;
    }
    
    if (placa.length > 8) {
        e.preventDefault();
        alert('La placa no puede tener más de 8 caracteres');
        document.getElementById('placa').focus();
        return false;
    }
    
    // Validar tipo de vehículo
    if (!tipo) {
        e.preventDefault();
        alert('Por favor seleccione el tipo de vehículo');
        document.getElementById('tipo_vehiculo').focus();
        return false;
    }
    
    // Validar propietario
    if (propietario.length < 3) {
        e.preventDefault();
        alert('Por favor ingrese el nombre completo del propietario (mínimo 3 caracteres)');
        document.getElementById('propietario').focus();
        return false;
    }
    
    // Si todo está bien, mostrar confirmación
    const confirmacion = confirm(
        `¿Confirma el registro del abono mensual?\n\n` +
        `Placa: ${placa}\n` +
        `Tipo: ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}\n` +
        `Propietario: ${propietario}\n` +
        `Costo: $${costosPorTipo[tipo].costo.toLocaleString('es-CO')}`
    );
    
    if (!confirmacion) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}